# Python utilities reference and examples

## Reference directory structure
Directory structure used in examples here.
```
.
├──IlluviumGame
│  └──Content
│     └──LocalTestData
│
├──simulation
│  └──build
│     └──bin
│        ├──simulation-cli.json
│        └──simulation-cli.exe
│
├──battles
│  ├──0.json
│  └──1.json
│
├──battle_results
│  ├──0
│  │  ├──0.prof.json
│  │  ├──0.prof
│  │  ├──duration.json
│  │  └──stdout.txt
│  └──1
│  │  ├──1.prof.json
│  │  ├──1.prof
│  │  ├──duration.json
│  │  └──stdout.txt
│  ...................
│
├──easy_profiler
│  └──bin
│     └──profiler_converter.exe
```

## `generate_random_battles.py`

Generates `--count` random combat files using combat units from `--json_data_dir`. `--seed` option controls random number generation (i.e. results will be the same when json files and `--seed` the same). Results will be stored in the path specified by `--output_dir` in form x.json, where x is an index of generated combat.

### Parameters
- `--json_data_dir` - path to a directory with json data. Usually it is path to a `LocalTestData` directory from game client repository.
- `--output_dir` - directory to store results.
- `--seed` - seed to initialize random number generator.
- `--combat_unit_line_filter` - optional parameter that allows you generate battles that consist only from combat units, whose line type fully matches specified regular expression.

### Example
```bash
# generate 300 combat files with seed 0
python3 ./simulation/tools/generate_random_battles.py --count 300 --seed 0 --json_data_dir ./IlluviumGame/Content/LocalTestData --output_dir ./battles
```

```bash
# generate 300 combat files using combat units, whose line type does not start with "Dummy" with seed 0
python3 ./simulation/tools/generate_random_battles.py --count 300 --seed 0 --json_data_dir ./IlluviumGame/Content/LocalTestData --output_dir ./battles --combat_unit_line_filter "^(?!Dummy).*"
```

## `run_battle_files.py`

### `run_directory` command

This command takes a path to a directory with battle files, gathers them using `*.json` globbing expression and runs each using `simulation-cli` executable.

#### Parameters
- `--sim_cli_path` - path to `simulation-cli` executable.
- `--battle_files_dir` - path to directory with battle files.
- `--json_data_dir` - path to a directory with json data. Usually it is path to a `LocalTestData` directory from game client repository.
- `--output_dir` - directory to store results.
- `--profile_converter_path` - path to a `profiler_converter` utility which is distributed with [easy_profiler](https://github.com/yse/easy_profiler).
- `--with_debug_logs` - optional parameter which enables debug logs. They are disabled by default since they are usually not required in the batch run and slow down the process significantly.
- `--with_valgrind` - optional parameter which enables simulation run through `valgrind --tool=memcheck`.

#### Example

This command will take all combats in `battles` directory, run them and store results in `battle_results` directory.

```bash
# run all battle files in ./battles dir
python3 ./simulation/tools/run_battle_files.py run_directory --sim_cli_path ./simulation/build/bin/simulation-cli --battle_files_dir ./battles --json_data_dir ./IlluviumGame/Content/LocalTestData --profile_converter_path ./easy_profiler/bin/profiler_converter --output_dir ./battle_results
```

#### Output

On each `battle_file_name.json` battle file found in `--battle_files_dir` the tool will run `simulation-cli` and store results for this battle in a spearate `battle_file_name` directory in the `--output_dir`. Here is the list of all possible files generated for each battle:
- `battle_file_name.prof` - this is a trace generated by `easy_profiler`. It will be generated if you have eanbled project profiling in build options (see [profiling.md](./../docs/profiling.md))
- `battle_file_name.prof.json` - profiling trace converted to json. It will be created if `battle_file_name.prof` exists and `--profile_converter_path` was specified correctly. This file is required for `profiling_summary.py` tool.
- `duration.json` - duration of the simulation process. Used by `compare_battle_results.py` to show difference in total duration of all simulations in the directory.
- `valgrind.log` - output of valgrind if `--with_valgrind` was specified.
- `stdout.json` - simulation output.
- `asan.log` - file with address sanitizer output (if any) for this battle. Will be generated only if simulation was built with address sanitizer enabled.
- `ubsan.log` - file with undefined behavior sanitizer output (if any) for this battle. Will be generated only if simulation was built with undefined sanitizer enabled.

### `ensure_determinism` command

This command takes a path to a battle file and runs it specified number of times, remembering resulting `stdout`. In the end it finds different variants of output and saves them in `--output_dir`.

#### Parameters
- `--sim_cli_path` - path to `simulation-cli` executable.
- `--battle_file_path` - path to battle file which will be simulated.
- `--json_data_dir` - path to a directory with json data. Usually it is path to a `LocalTestData` directory from game client repository.
- `--output_dir` - directory to store results.
- `--runs_count` - how many times specified battle file must be run.

#### Example

```bash
# run ./battles/0.json 100 times and save unique result variants in ./battle_results
python3 ./simulation/tools/run_battle_files.py ensure_determinism --sim_cli_path ./simulation/build/bin/simulation-cli --battle_file_path ./battles/0.json --json_data_dir ./IlluviumGame/Content/LocalTestData --output_dir ./battle_results --runs_count 100
```

#### Output
Each unique stdout variant will be saved in `--output_dir` with name `group_{group_index}_count_{count}.txt`, where `count` is how many times this stdout was detected among `--runs_count`.

## `compare_battle_results.py`
This tool compares two directories with battle results generated by `run_battle_files.py`.

### Example
```bash
# Compare battle_results_main and battle_results_current results
python3 ./simulation/tools/compare_battle_results.py --targets ./battle_results_main ./battle_results_current
```

Will print
```
Files count: 300
All same: True
Duration for battle_results: 109.48147177696228
Duration for battle_results: 109.48147177696228
```

## `profiling_summary.py`

This tool takes profiling trace and prints summary for each function. If there is more than one file they will be perceived as one continuous process.

### Parameters

There are two possible commands in this tool:
- `files` - accepts list of paths to profiling traces.
- `dirs` - path to a directory with profiling files. It also has optional `--glob` parameter to specify globbing expression. By default it is `*.prof.json`.

### Examples

```bash
# print summary for one file: 0.prof.json
python3 ./simulation/tools/profiling_summary.py files ./battle_results/0/0.prof.json

# print summary for two files: 0.prof.json
python3 ./simulation/tools/profiling_summary.py files ./battle_results/0/0.prof.json ./battle_results/1/1.prof.json

# print summary for the whole directory
python3 ./simulation/tools/profiling_summary.py dirs ./battle_results

# print summary for files that start with 11
python3 ./simulation/tools/profiling_summary.py dirs ./battle_results --glob "11*.prof.json"
```

## `convert_to_server_battle_json.py`

Converts battle file from game client format (or generated by `generate_random_battles.py`) to game server format (one giant json which contains all necessary data).

### Parameters

- `--json_data_dir` - path to the directory with json data.
- `--battle_file` - battle file in game client format.
- `--output_file` - path to resulting file in game server format.

### Examples

```bash
# convert 0.json to full_battle.json
python3 ./simulation/tools/convert_to_server_battle_json.py --battle_file ./battles/0.json --json_data_dir ./IlluviumGame/Content/LocalTestData --output_file ./full_battle.json
```
